{% extends "components/_base.html" %}

{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}

{% load static %}
{% load macros %}

{% block head %}
<meta name="robots" content="noindex, nofollow">

<meta name="csrf-token" content="{{ csrf_token }}">

<link rel="stylesheet" href="{% static 'css/animation.css' %}">

<style>
    /* For Correct/Incorrect overlay */
    .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0.3s ease, opacity 0.3s ease;
        z-index: 9999;
    }

    .overlay.visible {
        visibility: visible;
        opacity: 1;
    }

    .overlay-content {
        background: var(--bs-surface);
        border-radius: var(--bs-border-radius-lg);
        padding: 2rem 3rem;
        box-shadow: var(--bs-box-shadow-lg);
        text-align: center;
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }

    .overlay.visible .overlay-content {
        transform: scale(1);
    }

    .overlay i {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .overlay p {
        color: var(--bs-body-color);
        font-size: 1.5rem;
        margin: 0;
    }

    .overlay.correct .overlay-content {
        border: 2px solid var(--bs-success);
    }

    .overlay.incorrect .overlay-content {
        border: 2px solid var(--bs-danger);
    }

    .choice-button {
        transition: all 0.2s ease-in-out;
        min-height: 60px;
    }

    .choice-button:hover {
        transform: translateY(-2px);
        box-shadow: var(--bs-box-shadow);
    }

    .choice-button:active {
        transform: translateY(0);
    }
</style>
{% endblock %}


{% block content %}

<!-- HTML-Code für die Symbole -->
<div id="correct-overlay" class="overlay correct">
    <div class="overlay-content">
        <i class="bi bi-check-circle-fill text-success"></i>
        <p class="correct-text fw-bold"></p>
    </div>
</div>

<div id="incorrect-overlay" class="overlay incorrect">
    <div class="overlay-content">
        <i class="bi bi-x-circle-fill text-danger"></i>
        <p class="correct-text fw-bold"></p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
        <!-- Header Card with Stats -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <div class="row align-items-center">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-currency-exchange text-primary me-3" style="font-size: 2.5rem;"></i>
                            <div>
                                <h1 class="mb-0">Competitive Currencies</h1>
                                <p class="text-body-secondary mb-0 small">{% trans "Guess the currency of the displayed country" %}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row text-center text-md-end">
                            <div class="col-6 col-md-12 mb-2 mb-md-0">
                                <div class="d-flex align-items-center justify-content-center justify-content-md-end">
                                    <i class="bi bi-star-fill text-warning me-2" style="font-size: 1.25rem; line-height: 1; margin-top: -0.1rem;"></i>
                                    <div class="text-start text-md-end">
                                        <div class="small text-body-secondary">{% trans "Score" %}</div>
                                        <div class="h4 mb-0"><span id="score">0</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6 col-md-12">
                                <div class="d-flex align-items-center justify-content-center justify-content-md-end">
                                    <i class="bi bi-trophy-fill text-primary me-2" style="font-size: 1.25rem; line-height: 1; margin-top: -0.1rem;"></i>
                                    <div class="text-start text-md-end">
                                        <div class="small text-body-secondary">{% trans "Highscore" %}</div>
                                        <div class="h4 mb-0"><span id="high_score">0</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Card -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4 p-md-5">
                <div class="text-center mb-4">
                    <h3 id="country-name" class="mb-4"></h3>
                    <div class="mb-4">
                        <img id="image" src="" alt="flag of country" class="img-fluid rounded" style="max-width: 50%; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <button id="button-a" type="button" class="btn btn-outline-primary choice-button fw-bold w-100 d-flex align-items-center justify-content-between p-3">
                            <span class="badge bg-primary me-2">A</span>
                            <span id="choice-a-text" class="flex-grow-1 text-center">Choice A</span>
                            <span class="badge bg-primary" style="opacity: 0;">A</span>
                        </button>
                    </div>
                    <div class="col-12 col-md-6">
                        <button id="button-b" type="button" class="btn btn-outline-primary choice-button fw-bold w-100 d-flex align-items-center justify-content-between p-3">
                            <span class="badge bg-primary me-2">B</span>
                            <span id="choice-b-text" class="flex-grow-1 text-center">Choice B</span>
                            <span class="badge bg-primary" style="opacity: 0;">B</span>
                        </button>
                    </div>
                    <div class="col-12 col-md-6">
                        <button id="button-c" type="button" class="btn btn-outline-primary choice-button fw-bold w-100 d-flex align-items-center justify-content-between p-3">
                            <span class="badge bg-primary me-2">C</span>
                            <span id="choice-c-text" class="flex-grow-1 text-center">Choice C</span>
                            <span class="badge bg-primary" style="opacity: 0;">C</span>
                        </button>
                    </div>
                    <div class="col-12 col-md-6">
                        <button id="button-d" type="button" class="btn btn-outline-primary choice-button fw-bold w-100 d-flex align-items-center justify-content-between p-3">
                            <span class="badge bg-primary me-2">D</span>
                            <span id="choice-d-text" class="flex-grow-1 text-center">Choice D</span>
                            <span class="badge bg-primary" style="opacity: 0;">D</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Alert -->
        <div class="alert alert-primary border-0 shadow-sm d-flex align-items-center mb-4" role="alert">
            <i class="bi bi-info-circle-fill me-3" style="font-size: 1.5rem;"></i>
            <div>
                <strong>{% trans "Note" %}:</strong> {% trans "To make this game more challenging, hints to the country in the currency's name are replaced by an asterisk." %}
            </div>
        </div>

        <!-- Leaderboard Accordion -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="accordion" id="accordionExample">
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                <i class="bi bi-trophy me-2"></i>{% trans "Leaderboard" %}
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-modern mb-0">
                                        <thead>
                                            <tr>
                                                <th scope="col" style="width: 10%;">#</th>
                                                <th scope="col">{% trans "Username" %}</th>
                                                <th scope="col" style="width: 20%;" class="text-end">{% trans "Highscore" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    let score = {{ score }}
    let highscore = {{ highscore }}

    let country = {{ country | safe }}
    let choices = {{ choices | safe }}

    // DOM-Elemente initialisieren
    const country_name = document.getElementById("country-name")
    const image = document.getElementById("image")
    const score_span = document.getElementById("score")
    const highscore_span = document.getElementById("high_score")

    let choice_a_text = document.getElementById("choice-a-text")
    let choice_b_text = document.getElementById("choice-b-text")
    let choice_c_text = document.getElementById("choice-c-text")
    let choice_d_text = document.getElementById("choice-d-text")

    const button_a = document.getElementById("button-a")
    const button_b = document.getElementById("button-b")
    const button_c = document.getElementById("button-c")
    const button_d = document.getElementById("button-d")

    // Register Eventhandlers
    button_a.addEventListener("click", () => sendChoice("A"))
    button_b.addEventListener("click", () => sendChoice("B"))
    button_c.addEventListener("click", () => sendChoice("C"))
    button_d.addEventListener("click", () => sendChoice("D"))

    // First load initialization
    updateDisplay()

    function sendChoice(userChoice) {
        let csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content')

        if (userChoice === "A") { userChoice = choices["A"] }
        else if (userChoice === "B") { userChoice = choices["B"] }
        else if (userChoice === "C") { userChoice = choices["C"] }
        else if (userChoice === "D") { userChoice = choices["D"] }
        else { console.error("Invalid userChoice: " + userChoice) }

        fetch("/{{ LANGUAGE_CODE }}/worldle/currencies/competitive/", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: 'choice=' + userChoice
        })
            .then(response => response.json())
            .then(data => {
                country = data["country"]
                choices = data["choices"]
                score = data["score"]
                highscore = data["highscore"]
                updateDisplay()

                const is_correct = data["is_correct"]
                const correct_answers = data["correct_answers"]
                showOverlay(is_correct, correct_answers)

            })
            .catch(error => console.error('Error:', error))
    }

    function showOverlay(isCorrect, correct_answers) {
        let id = ""
        if (isCorrect) {
            id = "correct-overlay"
        } else {
            id = "incorrect-overlay"
        }

        const overlay = document.getElementById(id)
        const overlayTexts = document.getElementsByClassName("correct-text")

        overlayTexts[0].textContent = correct_answers
        overlayTexts[1].textContent = correct_answers

        overlay.classList.add("visible")

        // verzögertes Ausblenden des Overlays
        setTimeout(() => {
            overlay.classList.remove("visible")
        }, 700)
    }

    function updateDisplay() {
        updateLeaderboard()

        country_name.innerText = country["name"]
        image.src = country["image_url"]
        score_span.innerText = score
        highscore_span.innerText = highscore

        choice_a_text.innerText = choices["A"].toUpperCase()
        choice_b_text.innerText = choices["B"].toUpperCase()
        choice_c_text.innerText = choices["C"].toUpperCase()
        choice_d_text.innerText = choices["D"].toUpperCase()
        appendCurrencyNames()
    }

    function appendCurrencyNames() {
        const buttons = [button_a, button_b, button_c, button_d]
        const choiceTexts = [choice_a_text, choice_b_text, choice_c_text, choice_d_text]

        for (let i = 0; i < buttons.length; i++) {
            const button = buttons[i]
            const choiceText = choiceTexts[i]
            const code = choiceText.innerText

            fetch(`/{{ LANGUAGE_CODE }}/worldle/code_to_currency_name/${code}/`)
                .then(response => response.json())
                .then(data => {
                    const currencyName = data["currency_name"]
                    if (currencyName.length !== 0) {
                        console.error("Currency name is undefined")
                        choiceText.innerText += ` (${currencyName})`
                    }
                })
                .catch(error => console.error('Error:', error))
        }
    }

    function updateLeaderboard() {
        fetch('/{{ LANGUAGE_CODE }}/worldle/leaderboards/currencies_highscore/')
            .then(response => response.json())
            .then(data => {
                console.log(data)

                const tbody = document.querySelector(".table tbody")
                tbody.innerHTML = ""

                data.forEach((user, index) => {
                    const tr = document.createElement("tr")
                    const th = document.createElement("th")
                    th.scope = "row"
                    th.textContent = index + 1

                    const tdUsername = document.createElement("td")
                    tdUsername.textContent = user.username

                    const tdHighscore = document.createElement("td")
                    tdHighscore.textContent = user.highscore

                    tr.appendChild(th)
                    tr.appendChild(tdUsername)
                    tr.appendChild(tdHighscore)

                    tbody.appendChild(tr)
                })

            }).catch(error => console.error('Error:', error))
    }

</script>

{% endblock content %}
