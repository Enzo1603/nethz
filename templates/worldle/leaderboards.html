{% extends "components/_base.html" %}
{% load i18n %}
{% load macros %}

{% block content %}

<div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="mb-0">{% trans "Leaderboards" %}</h1>
    <span class="badge bg-primary-subtle text-primary-emphasis">
        <i class="bi bi-arrow-repeat me-1"></i>{% trans "Live updates" %}
    </span>
</div>

<div class="row">
    {% for leaderboard_config in leaderboard_configs %}
    {% leaderboard leaderboard_config %}
    {% endfor %}
</div>

<script defer>
    const LEADERBOARD_ENDPOINTS = {
        'Areas': '/worldle/leaderboards/areas_highscore/',
        'Capitals': '/worldle/leaderboards/capitals_highscore/',
        'Currencies': '/worldle/leaderboards/currencies_highscore/',
        'Languages': '/worldle/leaderboards/languages_highscore/'
    };

    const RANK_CLASSES = ['gold', 'silver', 'bronze'];

    function updateAllLeaderboards() {
        Object.entries(LEADERBOARD_ENDPOINTS).forEach(([id, url]) => {
            updateLeaderboard(id, url);
        });
    }

    function updateLeaderboard(tableId, url) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        const loadingRow = document.querySelector(`#${tableId}-loading`);
        const emptyRow = document.querySelector(`#${tableId}-empty`);

        if (!tbody) return;

        // Show loading
        if (loadingRow) loadingRow.style.display = '';
        if (emptyRow) emptyRow.style.display = 'none';

        // Remove existing data rows
        tbody.querySelectorAll('tr:not([id])').forEach(row => row.remove());

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Network error');
                return response.json();
            })
            .then(data => {
                if (loadingRow) loadingRow.style.display = 'none';

                if (!data?.length) {
                    if (emptyRow) emptyRow.style.display = '';
                    return;
                }

                if (emptyRow) emptyRow.style.display = 'none';

                data.forEach((user, index) => {
                    const tr = document.createElement('tr');
                    const rankClass = RANK_CLASSES[index] || '';
                    
                    tr.innerHTML = `
                        <th scope="row" class="leaderboard-rank ${rankClass}">${index + 1}</th>
                        <td>${escapeHtml(user.username)}</td>
                        <td><strong>${user.highscore}</strong></td>
                    `;
                    tbody.appendChild(tr);
                });
            })
            .catch(error => {
                console.error('Leaderboard error:', error);
                if (loadingRow) loadingRow.style.display = 'none';
                if (emptyRow) {
                    emptyRow.innerHTML = '<td colspan="3" class="text-center py-4 text-danger"><i class="bi bi-exclamation-triangle me-2"></i>{% trans "Error loading data" %}</td>';
                    emptyRow.style.display = '';
                }
            });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initial load and auto-refresh
    updateAllLeaderboards();
    setInterval(updateAllLeaderboards, 20000);
</script>

{% endblock content %}
